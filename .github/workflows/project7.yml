name: Project 7

on:
  workflow_dispatch:

env:
  TARGET_REPO: imjac0b/${{ secrets.PROJECT_7_REPO }}
  TARGET_BASE_URL: ${{ secrets.PROJECT_7_URL }}
  ARTIFACT_PATTERN: app-*
  DEVELOPER_NAME: ${{ secrets.PROJECT_7_DEVELOPER_NAME }}
  SOURCE_JSON_BASE: ${{ secrets.PROJECT_7_SOURCE_JSON_BASE }}

jobs:
  build:
    name: Build ${{ matrix.app }}
    runs-on: macos-26
    strategy:
      fail-fast: false
      matrix:
        include:
          - app: Verse
            repo: imjac0b/verse
            scheme: Verse
            
    steps:
      - name: Checkout App Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          fetch-depth: 1
          token: ${{ secrets.PROJECT_7_TOKEN }}

      - name: Build Archive (Unsigned)
        run: |
          mkdir -p dist
          xcodebuild -scheme "${{ matrix.scheme }}" \
            -sdk iphoneos \
            -configuration Release \
            archive \
            -archivePath ./dist/build/App.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - name: Extract Metadata & Icon
        id: metadata
        run: |
          APP_BUNDLE_PATH="./dist/build/App.xcarchive/Products/Applications/${{ matrix.scheme }}.app"
          INFO_PLIST="$APP_BUNDLE_PATH/Info.plist"
          
          VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$INFO_PLIST")
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$INFO_PLIST")
          DISPLAY_NAME=$(/usr/libexec/PlistBuddy -c "Print :CFBundleDisplayName" "$INFO_PLIST" 2>/dev/null || /usr/libexec/PlistBuddy -c "Print :CFBundleName" "$INFO_PLIST")
          
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%s | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
          
          # Try to find the largest icon in the bundle
          # Usually named AppIcon60x60@3x.png or similar if not in Assets.car
          # Since Xcode compiles assets, we'll look for any png with 'Icon' in the name
          # Or we can try to export it using sips from the compiled icon if available (complex)
          
          # SIMPLE METHOD: Look for the AppIcon in the source tree first? No, we only have the build.
          # FALLBACK: We will search the .app for any PNG that looks like an icon.
          
          find "$APP_BUNDLE_PATH" -name "AppIcon*.png" | sort -r | head -n 1 > icon_path.txt
          ICON_SRC=$(cat icon_path.txt)
          
          if [ -z "$ICON_SRC" ]; then
             echo "No raw icon found (likely in Assets.car). using placeholder."
             touch dist/icon.png
          else
             cp "$ICON_SRC" dist/icon.png
          fi

          cat <<EOF > dist/metadata.json
          {
            "name": "$DISPLAY_NAME",
            "bundleIdentifier": "$BUNDLE_ID",
            "version": "$VERSION",
            "scheme": "${{ matrix.scheme }}"
          }
          EOF
          
          python3 -c "import json; f='dist/metadata.json'; d=json.load(open(f)); d.update({'commitHash': '$COMMIT_HASH', 'commitMsg': '$COMMIT_MSG'}); json.dump(d, open(f,'w'))"

      - name: Package IPA
        env:
          ZIP_PASS: ${{ secrets.PROJECT_7_TOKEN }}
        run: |
          cd dist
          mkdir -p Payload
          cp -r ./build/App.xcarchive/Products/Applications/${{ matrix.scheme }}.app ./Payload/
          
          zip -r ./${{ matrix.scheme }}.ipa ./Payload
          
          # Include icon.png in the encrypted bundle
          zip -P "$ZIP_PASS" -r bundle.zip ${{ matrix.scheme }}.ipa metadata.json icon.png
          
          rm -rf Payload build ${{ matrix.scheme }}.ipa metadata.json icon.png

      - name: Upload Encrypted Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.scheme }}
          path: dist/bundle.zip
          retention-days: 1

  publish:
    name: Publish
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: ${{ env.ARTIFACT_PATTERN }}
          merge-multiple: false

      - name: Decrypt Artifacts
        env:
          ZIP_PASS: ${{ secrets.PROJECT_7_TOKEN }}
        run: |
          for app_dir in artifacts/*/; do
            if [ -f "${app_dir}bundle.zip" ]; then
              echo "Decrypting inside $app_dir..."
              (
                cd "$app_dir"
                # Unzip with password
                unzip -P "$ZIP_PASS" bundle.zip
                rm bundle.zip
              )
            fi
          done

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate Source & Prepare
        run: |
          cat << 'EOF' > gen_altstore.py
          import os
          import json
          import shutil
          from datetime import datetime
          
          target_url = os.environ["TARGET_BASE_URL"]
          dev_name = os.environ["DEVELOPER_NAME"]
          output_dir = "release_dist"
          os.makedirs(output_dir, exist_ok=True)
          
          # Load base JSON from env
          source_json = json.loads(os.environ["SOURCE_JSON_BASE"])
          
          artifacts_root = "artifacts"
          
          if os.path.exists(artifacts_root):
              folders = sorted(os.listdir(artifacts_root))
          else:
              folders = []
          
          for artifact_folder in folders:
              folder_path = os.path.join(artifacts_root, artifact_folder)
              if not os.path.isdir(folder_path): continue
                  
              meta_file = os.path.join(folder_path, "metadata.json")
              if not os.path.exists(meta_file): continue
                  
              with open(meta_file, "r") as f:
                  meta = json.load(f)
              
              scheme = meta["scheme"]
              ipa_filename = f"{scheme}.ipa"
              icon_filename = f"{scheme}.png"
              
              ipa_src = os.path.join(folder_path, ipa_filename)
              icon_src = os.path.join(folder_path, "icon.png")
              
              if os.path.exists(ipa_src):
                  shutil.copy2(ipa_src, os.path.join(output_dir, ipa_filename))
                  
                  # Handle Icon
                  final_icon_url = ""
                  if os.path.exists(icon_src) and os.path.getsize(icon_src) > 0:
                      shutil.copy2(icon_src, os.path.join(output_dir, icon_filename))
                      final_icon_url = f"{target_url}/{icon_filename}"
                  else:
                      final_icon_url = f"{target_url}/default_icon.png"

                  commit_msg = meta.get("commitMsg", "Update")
                  commit_hash = meta.get("commitHash", "unknown")
                  date_str = datetime.now().strftime("%Y-%m-%d")
                  version_desc = f"{commit_msg} ({commit_hash})\nUpdated: {date_str}"
                  
                  app_entry = {
                      "name": meta['name'],
                      "bundleIdentifier": meta['bundleIdentifier'],
                      "developerName": dev_name,
                      "version": meta['version'],
                      "versionDate": date_str,
                      "versionDescription": version_desc,
                      "downloadURL": f"{target_url}/{ipa_filename}",
                      "localizedDescription": f"{meta['name']} by {dev_name}",
                      "iconURL": final_icon_url,
                      "size": os.path.getsize(ipa_src)
                  }
                  source_json["apps"].append(app_entry)
                  print(f"Processed {meta['name']}")
          
          with open(os.path.join(output_dir, "apps.json"), "w") as f:
              json.dump(source_json, f, indent=2)
          EOF
          
          python3 gen_altstore.py

      - name: Force Push to Target Repo
        env:
          API_TOKEN_GITHUB: ${{ secrets.PROJECT_7_TOKEN }}
        run: |
          cd release_dist
          git init
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git checkout -b main
          git add .
          git commit -m "Deploy Apps: $(date)"
          
          git remote add origin https://x-access-token:$API_TOKEN_GITHUB@github.com/$TARGET_REPO.git
          git push -u --force origin main

      - name: Cleanup Artifacts
        if: always()
        uses: geekyeggo/delete-artifact@v2
        with:
          name: ${{ env.ARTIFACT_PATTERN }}
          failOnError: false
